---

---

<!-- Modal Container -->
<div
  id="event-modal"
  class="fixed inset-0 z-50 hidden items-center justify-center p-2 sm:p-4 bg-black/60"
  aria-hidden="true"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-xl sm:rounded-2xl shadow-2xl max-w-5xl w-full max-h-[95vh] sm:max-h-[90vh] overflow-hidden animate-modal-appear"
    role="dialog"
    aria-modal="true"
  >
    <!-- Header -->
    <div
      id="modal-header"
      class="sticky top-0 z-10 bg-gradient-to-r from-blue-500 to-purple-600 px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between shadow-lg"
    >
      <h2
        id="modal-title"
        class="text-lg sm:text-xl md:text-2xl font-bold text-white"
      >
        Evento
      </h2>
      <button
        id="close-modal"
        class="p-1.5 sm:p-2 rounded-lg hover:bg-white/20 transition-colors flex-shrink-0"
        aria-label="Cerrar modal"
      >
        <svg
          class="w-5 h-5 sm:w-6 sm:h-6 text-white"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Content -->
    <div
      class="overflow-y-auto max-h-[calc(95vh-60px)] sm:max-h-[calc(90vh-80px)] p-4 sm:p-6"
    >
      <div id="modal-content" class="space-y-4 sm:space-y-6">
        <!-- El contenido se inyectar√° din√°micamente -->
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes modal-appear {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-modal-appear {
    animation: modal-appear 0.15s ease-out;
    will-change: transform, opacity;
  }

  .animate-modal-appear::after {
    will-change: auto;
  }

  #event-modal.show {
    display: flex;
  }

  /* Prevenir scroll del body cuando el modal est√° abierto */
  body.modal-open {
    overflow: hidden;
  }
</style>

<script>
  import type { Event } from "../data/events";
  import { getAllEvents } from "../data/events";
  import { format, parseISO } from "date-fns";
  import { es } from "date-fns/locale";

  // Mapeo de categor√≠as a colores (coincide exactamente con EventCard)
  const categoryColors: Record<string, string> = {
    COMMUNITY_DAY: "green",
    RAID_DAY: "red",
    RAID_HOUR: "purple",
    EVENT: "blue",
    SPOTLIGHT: "yellow",
    MAX_MONDAY: "pink",
    SHADOW_ROTATION: "gray",
    GO_PASS: "teal",
    PVP: "indigo",
    RAID_ROTATION: "orange",
    MEGA_ROTATION: "cyan",
    RESEARCH: "yellow",
    OTHER: "gray",
  };

  const categoryLabels: Record<string, string> = {
    COMMUNITY_DAY: "Community Day",
    RAID_DAY: "Raid Day",
    RAID_HOUR: "Raid Hour",
    EVENT: "Evento",
    SPOTLIGHT: "Spotlight Hour",
    MAX_MONDAY: "Max Monday",
    SHADOW_ROTATION: "Shadow Rotation",
    GO_PASS: "GO Pass",
    PVP: "GO Battle League",
    RAID_ROTATION: "Raid Rotation",
    MEGA_ROTATION: "Mega Rotation",
    RESEARCH: "Investigaci√≥n",
    OTHER: "Otro",
  };

  function getColor(category: string): string {
    return categoryColors[category] || "gray";
  }

  // Helper functions para obtener clases completas de Tailwind (no din√°micas)
  function getBorderClasses(color: string): string {
    const classes: Record<string, string> = {
      green: "border-green-500",
      red: "border-red-500",
      purple: "border-purple-500",
      blue: "border-blue-500",
      yellow: "border-yellow-500",
      pink: "border-pink-500",
      gray: "border-slate-600",
      teal: "border-teal-500",
      indigo: "border-indigo-500",
      orange: "border-orange-500",
      cyan: "border-cyan-500",
    };
    return classes[color] || classes.gray;
  }

  function getHeaderBgClasses(color: string): string {
    const classes: Record<string, string> = {
      green: "bg-green-500",
      red: "bg-red-500",
      purple: "bg-purple-500",
      blue: "bg-blue-500",
      yellow: "bg-yellow-500",
      pink: "bg-pink-500",
      gray: "bg-gray-600",
      teal: "bg-teal-500",
      indigo: "bg-indigo-500",
      orange: "bg-orange-500",
      cyan: "bg-cyan-500",
    };
    return classes[color] || classes.gray;
  }

  function getHeaderBorderClasses(color: string): string {
    const classes: Record<string, string> = {
      green: "border-green-500",
      red: "border-red-500",
      purple: "border-purple-500",
      blue: "border-blue-500",
      yellow: "border-yellow-500",
      pink: "border-pink-500",
      gray: "border-slate-600",
      teal: "border-teal-500",
      indigo: "border-indigo-500",
      orange: "border-orange-500",
      cyan: "border-cyan-500",
    };
    return classes[color] || classes.gray;
  }

  function getTitleTextClasses(color: string): string {
    const classes: Record<string, string> = {
      green: "text-green-600 dark:text-green-400",
      red: "text-red-600 dark:text-red-400",
      purple: "text-purple-600 dark:text-purple-400",
      blue: "text-blue-600 dark:text-blue-400",
      yellow: "text-yellow-600 dark:text-yellow-400",
      pink: "text-pink-600 dark:text-pink-400",
      gray: "text-gray-600 dark:text-gray-400",
      teal: "text-teal-600 dark:text-teal-400",
      indigo: "text-indigo-600 dark:text-indigo-400",
      orange: "text-orange-600 dark:text-orange-400",
      cyan: "text-cyan-600 dark:text-cyan-400",
    };
    return classes[color] || classes.gray;
  }

  function getBadgeBgClasses(color: string): string {
    const classes: Record<string, string> = {
      green: "bg-green-700 dark:bg-green-600",
      red: "bg-red-700 dark:bg-red-600",
      purple: "bg-purple-700 dark:bg-purple-600",
      blue: "bg-blue-700 dark:bg-blue-600",
      yellow: "bg-yellow-700 dark:bg-yellow-600",
      pink: "bg-pink-700 dark:bg-pink-600",
      gray: "bg-gray-700 dark:bg-gray-600",
      teal: "bg-teal-700 dark:bg-teal-600",
      indigo: "bg-indigo-700 dark:bg-indigo-600",
      orange: "bg-orange-700 dark:bg-orange-600",
      cyan: "bg-cyan-700 dark:bg-cyan-600",
    };
    return classes[color] || classes.gray;
  }

  function getTimeBgClasses(color: string): string {
    const classes: Record<string, string> = {
      green: "bg-green-50 dark:bg-green-900/20",
      red: "bg-red-50 dark:bg-red-900/20",
      purple: "bg-purple-50 dark:bg-purple-900/20",
      blue: "bg-blue-50 dark:bg-blue-900/20",
      yellow: "bg-yellow-50 dark:bg-yellow-900/20",
      pink: "bg-pink-50 dark:bg-pink-900/20",
      gray: "bg-gray-50 dark:bg-gray-900/20",
      teal: "bg-teal-50 dark:bg-teal-900/20",
      indigo: "bg-indigo-50 dark:bg-indigo-900/20",
      orange: "bg-orange-50 dark:bg-orange-900/20",
      cyan: "bg-cyan-50 dark:bg-cyan-900/20",
    };
    return classes[color] || classes.gray;
  }

  function getTimeBorderClasses(color: string): string {
    const classes: Record<string, string> = {
      green: "border-green-200 dark:border-green-700",
      red: "border-red-200 dark:border-red-700",
      purple: "border-purple-200 dark:border-purple-700",
      blue: "border-blue-200 dark:border-blue-700",
      yellow: "border-yellow-200 dark:border-yellow-700",
      pink: "border-pink-200 dark:border-pink-700",
      gray: "border-gray-200 dark:border-gray-700",
      teal: "border-teal-200 dark:border-teal-700",
      indigo: "border-indigo-200 dark:border-indigo-700",
      orange: "border-orange-200 dark:border-orange-700",
      cyan: "border-cyan-200 dark:border-cyan-700",
    };
    return classes[color] || classes.gray;
  }

  function getLinkBgClasses(color: string): string {
    const classes: Record<string, string> = {
      green:
        "bg-green-700 hover:bg-green-800 dark:bg-green-600 dark:hover:bg-green-700",
      red: "bg-red-700 hover:bg-red-800 dark:bg-red-600 dark:hover:bg-red-700",
      purple:
        "bg-purple-700 hover:bg-purple-800 dark:bg-purple-600 dark:hover:bg-purple-700",
      blue: "bg-blue-700 hover:bg-blue-800 dark:bg-blue-600 dark:hover:bg-blue-700",
      yellow:
        "bg-yellow-700 hover:bg-yellow-800 dark:bg-yellow-600 dark:hover:bg-yellow-700",
      pink: "bg-pink-700 hover:bg-pink-800 dark:bg-pink-600 dark:hover:bg-pink-700",
      gray: "bg-gray-700 hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-700",
      teal: "bg-teal-700 hover:bg-teal-800 dark:bg-teal-600 dark:hover:bg-teal-700",
      indigo:
        "bg-indigo-700 hover:bg-indigo-800 dark:bg-indigo-600 dark:hover:bg-indigo-700",
      orange:
        "bg-orange-700 hover:bg-orange-800 dark:bg-orange-600 dark:hover:bg-orange-700",
      cyan: "bg-cyan-700 hover:bg-cyan-800 dark:bg-cyan-600 dark:hover:bg-cyan-700",
    };
    return classes[color] || classes.gray;
  }

  function getSectionItemBgClasses(color: string): string {
    const classes: Record<string, string> = {
      green: "bg-green-50 dark:bg-green-900/20",
      red: "bg-red-50 dark:bg-red-900/20",
      purple: "bg-purple-50 dark:bg-purple-900/20",
      blue: "bg-blue-50 dark:bg-blue-900/20",
      yellow: "bg-yellow-50 dark:bg-yellow-900/20",
      pink: "bg-pink-50 dark:bg-pink-900/20",
      gray: "bg-gray-50 dark:bg-gray-900/20",
      teal: "bg-teal-50 dark:bg-teal-900/20",
      indigo: "bg-indigo-50 dark:bg-indigo-900/20",
      orange: "bg-orange-50 dark:bg-orange-900/20",
      cyan: "bg-cyan-50 dark:bg-cyan-900/20",
    };
    return classes[color] || classes.gray;
  }

  function getSectionItemBorderClasses(color: string): string {
    const classes: Record<string, string> = {
      green: "border-green-300 dark:border-green-700",
      red: "border-red-300 dark:border-red-700",
      purple: "border-purple-300 dark:border-purple-700",
      blue: "border-blue-300 dark:border-blue-700",
      yellow: "border-yellow-300 dark:border-yellow-700",
      pink: "border-pink-300 dark:border-pink-700",
      gray: "border-gray-300 dark:border-gray-700",
      teal: "border-teal-300 dark:border-teal-700",
      indigo: "border-indigo-300 dark:border-indigo-700",
      orange: "border-orange-300 dark:border-orange-700",
      cyan: "border-cyan-300 dark:border-cyan-700",
    };
    return classes[color] || classes.gray;
  }

  function getSectionItemTextClasses(color: string): string {
    const classes: Record<string, string> = {
      green: "text-green-700 dark:text-green-300",
      red: "text-red-700 dark:text-red-300",
      purple: "text-purple-700 dark:text-purple-300",
      blue: "text-blue-700 dark:text-blue-300",
      yellow: "text-yellow-700 dark:text-yellow-300",
      pink: "text-pink-700 dark:text-pink-300",
      gray: "text-gray-700 dark:text-gray-300",
      teal: "text-teal-700 dark:text-teal-300",
      indigo: "text-indigo-700 dark:text-indigo-300",
      orange: "text-orange-700 dark:text-orange-300",
      cyan: "text-cyan-700 dark:text-cyan-300",
    };
    return classes[color] || classes.gray;
  }

  function createBadge(status: string): HTMLElement {
    const badge = document.createElement("span");
    badge.className =
      "px-3 py-1 text-xs font-semibold rounded-full inline-flex items-center gap-1";

    if (status === "CONFIRMED") {
      badge.classList.add(
        "bg-green-100",
        "dark:bg-green-900/30",
        "text-green-800",
        "dark:text-green-300"
      );
      badge.innerHTML = "<span>‚úì</span><span>CONFIRMADO</span>";
    } else if (status === "TENTATIVE") {
      badge.classList.add(
        "bg-yellow-100",
        "dark:bg-yellow-900/30",
        "text-yellow-800",
        "dark:text-yellow-300"
      );
      badge.innerHTML = "<span>‚ö†</span><span>TENTATIVO</span>";
    } else {
      badge.classList.add(
        "bg-gray-100",
        "dark:bg-gray-900/30",
        "text-gray-800",
        "dark:text-gray-300"
      );
      badge.innerHTML = "<span>?</span><span>POR DETERMINAR</span>";
    }

    return badge;
  }

  function createSection(
    title: string,
    icon: string,
    items: string[],
    color: string
  ): HTMLElement {
    const section = document.createElement("div");
    section.className = "space-y-3";

    const header = document.createElement("h3");
    header.className =
      "text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2";
    header.innerHTML = `<span class="text-2xl">${icon}</span><span>${title}</span>`;
    section.appendChild(header);

    const list = document.createElement("div");
    list.className = "space-y-2";

    items.forEach((item) => {
      const itemDiv = document.createElement("div");
      itemDiv.className = `${getSectionItemBgClasses(color)} px-4 py-3 rounded-lg border ${getSectionItemBorderClasses(color)}`;

      const text = document.createElement("p");
      text.className = `${getSectionItemTextClasses(color)} text-sm font-medium`;
      text.textContent = item;

      itemDiv.appendChild(text);
      list.appendChild(itemDiv);
    });

    section.appendChild(list);
    return section;
  }

  function renderDayEventsModal(date: string, events: any[]) {
    const modal = document.getElementById("event-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalContent = document.getElementById("modal-content");
    const modalHeader = document.getElementById("modal-header");

    if (!modal || !modalTitle || !modalContent || !modalHeader) return;

    // Limpiar contenido anterior
    modalContent.innerHTML = "";

    // Scroll al inicio
    const contentContainer = modalContent.parentElement;
    if (contentContainer) {
      contentContainer.scrollTop = 0;
    }

    // Formatear fecha para el t√≠tulo
    const dateObj = parseISO(date);
    const formattedDate = format(dateObj, "EEEE d 'de' MMMM, yyyy", {
      locale: es,
    });
    modalTitle.textContent = `Eventos del ${formattedDate}`;

    // Actualizar color del header seg√∫n el primer evento
    if (events.length > 0) {
      const allEvents = getAllEvents();
      const firstEvent = allEvents.find((e: Event) => e.id === events[0].id);
      if (firstEvent) {
        const headerColor = getColor(firstEvent.category);

        // Mapear a clases completas de Tailwind (no din√°micas)
        const headerBgClass: Record<string, string> = {
          emerald: "bg-emerald-600 dark:bg-emerald-700",
          red: "bg-red-600 dark:bg-red-700",
          rose: "bg-rose-600 dark:bg-rose-700",
          purple: "bg-purple-600 dark:bg-purple-700",
          orange: "bg-orange-600 dark:bg-orange-700",
          sky: "bg-sky-600 dark:bg-sky-700",
          slate: "bg-slate-600 dark:bg-slate-700",
          teal: "bg-teal-600 dark:bg-teal-700",
          blue: "bg-blue-600 dark:bg-blue-700",
          fuchsia: "bg-fuchsia-600 dark:bg-fuchsia-700",
          amber: "bg-amber-600 dark:bg-amber-700",
        };

        const bgClasses =
          headerBgClass[headerColor] || "bg-blue-600 dark:bg-blue-700";
        modalHeader.className = `sticky top-0 z-10 ${bgClasses} px-6 py-4 rounded-t-lg flex items-center justify-between`;
      }
    }

    // Crear contenedor para todos los eventos
    const eventsContainer = document.createElement("div");
    eventsContainer.className = "space-y-6";

    // Renderizar cada evento
    events.forEach((eventData, index) => {
      const event = getAllEvents().find((e: Event) => e.id === eventData.id);
      if (!event) return;

      const color = getColor(event.category);

      // Contenedor del evento
      const eventDiv = document.createElement("div");
      eventDiv.className = `border-2 ${getBorderClasses(color)} rounded-xl overflow-hidden ${index > 0 ? "mt-6" : ""}`;

      // Header del evento con color mejorado para contraste
      const eventHeader = document.createElement("div");
      eventHeader.className = `${getHeaderBgClasses(color)} px-5 py-3 border-b-2 ${getHeaderBorderClasses(color)}`;

      const eventTitle = document.createElement("h3");
      eventTitle.className = `text-xl font-bold text-white flex items-center gap-2`;

      // Crear badge de categor√≠a con mejor contraste
      const categoryBadge = document.createElement("span");
      categoryBadge.className = `inline-flex items-center px-3 py-1 bg-white/20 text-white text-xs font-semibold rounded-full mr-2 shadow-sm`;
      categoryBadge.textContent =
        categoryLabels[event.category] || event.category;

      eventTitle.appendChild(categoryBadge);
      eventTitle.appendChild(document.createTextNode(event.title));
      eventHeader.appendChild(eventTitle);
      eventDiv.appendChild(eventHeader);

      // Contenido del evento
      const eventContent = document.createElement("div");
      eventContent.className = "p-5 space-y-4";

      // Status
      const statusDiv = document.createElement("div");
      statusDiv.appendChild(createBadge(event.status));
      eventContent.appendChild(statusDiv);

      // Horario con mejor contraste
      const timeDiv = document.createElement("div");
      timeDiv.className = `${getTimeBgClasses(color)} rounded-lg p-4 border ${getTimeBorderClasses(color)}`;
      const startTime = format(parseISO(event.start), "HH:mm", { locale: es });
      const endTime = format(parseISO(event.end), "HH:mm", { locale: es });
      timeDiv.innerHTML = `
        <div class="flex items-center gap-2 ${getTitleTextClasses(color)} font-semibold">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="font-semibold">${startTime} - ${endTime}</span>
        </div>
      `;
      eventContent.appendChild(timeDiv);

      // Descripci√≥n
      if (event.description) {
        const descDiv = document.createElement("div");
        descDiv.className = "text-gray-700 dark:text-gray-300";
        descDiv.innerHTML = `<p class="leading-relaxed">${event.description}</p>`;
        eventContent.appendChild(descDiv);
      }

      // Notas
      if (event.notes) {
        const notesDiv = document.createElement("div");
        notesDiv.className =
          "bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 p-3 rounded-r-lg";
        notesDiv.innerHTML = `
          <p class="text-sm text-blue-700 dark:text-blue-300"><strong>üí° Nota:</strong> ${event.notes}</p>
        `;
        eventContent.appendChild(notesDiv);
      }

      // Debuts
      if (event.debuts && event.debuts.length > 0) {
        eventContent.appendChild(
          createSection("Debuts", "‚≠ê", event.debuts, "purple")
        );
      }

      // Bonificaciones
      if (event.bonuses && event.bonuses.length > 0) {
        eventContent.appendChild(
          createSection("Bonificaciones", "üéÅ", event.bonuses, "blue")
        );
      }

      // Apariciones
      if (event.spawns && event.spawns.length > 0) {
        eventContent.appendChild(
          createSection("Apariciones", "üåü", event.spawns, "green")
        );
      }

      // Incursiones
      if (event.raids && event.raids.length > 0) {
        eventContent.appendChild(
          createSection("Incursiones", "‚öîÔ∏è", event.raids, "red")
        );
      }

      // Movimientos Destacados
      if (event.featuredMoves && event.featuredMoves.length > 0) {
        eventContent.appendChild(
          createSection(
            "Movimientos Destacados",
            "üí´",
            event.featuredMoves,
            "indigo"
          )
        );
      }

      // Tareas de Investigaci√≥n
      if (event.researchTasks && event.researchTasks.length > 0) {
        eventContent.appendChild(
          createSection(
            "Tareas de Investigaci√≥n",
            "üî¨",
            event.researchTasks,
            "yellow"
          )
        );
      }

      // Enlaces
      if (event.links && event.links.length > 0) {
        const linksDiv = document.createElement("div");
        linksDiv.className = "flex flex-wrap gap-2 mt-3";

        event.links.forEach((link) => {
          const linkBtn = document.createElement("a");
          linkBtn.href = link.url;
          linkBtn.target = "_blank";
          linkBtn.rel = "noopener noreferrer";
          linkBtn.className = `inline-flex items-center gap-2 px-3 py-2 ${getLinkBgClasses(color)} text-white rounded-lg transition-colors text-xs font-semibold shadow-sm`;
          linkBtn.innerHTML = `
            <span>${link.title}</span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          `;
          linksDiv.appendChild(linkBtn);
        });

        eventContent.appendChild(linksDiv);
      }

      eventDiv.appendChild(eventContent);
      eventsContainer.appendChild(eventDiv);
    });

    modalContent.appendChild(eventsContainer);

    // Mostrar modal
    modal.classList.remove("hidden");
    modal.classList.add("show");
    modal.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
  }

  function closeModal() {
    const modal = document.getElementById("event-modal");
    const modalContent = document.getElementById("modal-content");

    if (modal) {
      // Reset scroll position
      const contentContainer = modalContent?.parentElement;
      if (contentContainer) {
        contentContainer.scrollTop = 0;
      }

      modal.classList.remove("show");
      modal.classList.add("hidden");
      modal.setAttribute("aria-hidden", "true");
      document.body.classList.remove("modal-open");
    }
  }

  // Event Listeners
  document.addEventListener("DOMContentLoaded", () => {
    const closeBtn = document.getElementById("close-modal");
    const modal = document.getElementById("event-modal");

    closeBtn?.addEventListener("click", closeModal);

    modal?.addEventListener("click", (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeModal();
      }
    });

    // Escuchar eventos de tarjetas individuales
    document.addEventListener("event-selected", ((e: CustomEvent) => {
      const { eventId } = e.detail;
      if (eventId) {
        // Mostrar evento individual como un array de 1
        const allEvents = getAllEvents();
        const event = allEvents.find((ev) => ev.id === eventId);
        if (event) {
          const today = format(parseISO(event.start), "yyyy-MM-dd");
          renderDayEventsModal(today, [{ id: event.id }]);
        }
      }
    }) as EventListener);

    // Escuchar clics en d√≠as del calendario
    window.addEventListener("calendar-day-selected", ((e: CustomEvent) => {
      const { date, events } = e.detail;
      if (events && events.length > 0) {
        renderDayEventsModal(date, events);
      }
    }) as EventListener);
  });
</script>
