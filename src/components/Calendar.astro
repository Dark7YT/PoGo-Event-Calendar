---
import { getAllEvents, type EventCategory } from "../data/events";
import {
  format,
  startOfMonth,
  endOfMonth,
  eachDayOfInterval,
  isToday,
  parseISO,
} from "date-fns";
import { es } from "date-fns/locale";

const currentDate = new Date("2026-01-15"); // Fecha de referencia para el calendario
const monthStart = startOfMonth(currentDate);
const monthEnd = endOfMonth(currentDate);
const daysInMonth = eachDayOfInterval({ start: monthStart, end: monthEnd });

// Obtener el día de la semana del primer día (0 = domingo, 1 = lunes, etc.)
const firstDayOfWeek = monthStart.getDay();

// Crear array de días incluyendo días vacíos al inicio
const calendarDays = Array(firstDayOfWeek).fill(null).concat(daysInMonth);

// Obtener TODOS los eventos (incluye children)
const allEvents = getAllEvents();

// Función para obtener eventos de un día específico
function getEventsForDay(day: Date) {
  return allEvents.filter((event) => {
    const eventStart = parseISO(event.start);
    const eventEnd = parseISO(event.end);
    const dayStart = new Date(day.getFullYear(), day.getMonth(), day.getDate());
    const dayEnd = new Date(
      day.getFullYear(),
      day.getMonth(),
      day.getDate(),
      23,
      59,
      59
    );
    return eventStart <= dayEnd && eventEnd >= dayStart;
  });
}

// Función para obtener color según categoría de evento
// Colores optimizados para legibilidad en modo claro y oscuro
function getEventColor(category: EventCategory) {
  const colors: Record<EventCategory, string> = {
    COMMUNITY_DAY: "bg-emerald-600 dark:bg-emerald-500", // Verde brillante legible
    RAID_DAY: "bg-red-600 dark:bg-red-500", // Rojo legible
    EVENT: "bg-purple-600 dark:bg-purple-500", // Púrpura legible
    SPOTLIGHT: "bg-orange-600 dark:bg-orange-500", // Naranja legible
    RAID_HOUR: "bg-rose-600 dark:bg-rose-500", // Rosa/rojo legible
    MAX_MONDAY: "bg-sky-600 dark:bg-sky-500", // Azul cielo legible
    PVP: "bg-blue-700 dark:bg-blue-600", // Azul oscuro legible
    GO_PASS: "bg-teal-600 dark:bg-teal-500", // Verde azulado legible
    RAID_ROTATION: "bg-red-600 dark:bg-red-500",
    MEGA_ROTATION: "bg-fuchsia-600 dark:bg-fuchsia-500", // Fucsia legible
    SHADOW_ROTATION: "bg-gray-700 dark:bg-gray-600", // Gris legible
    RESEARCH: "bg-amber-600 dark:bg-amber-500", // Amarillo/ámbar legible
    OTHER: "bg-gray-600 dark:bg-gray-500",
  };
  return colors[category] || "bg-gray-600 dark:bg-gray-500";
}
---

<div
  class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 lg:p-10 transition-colors"
>
  <!-- Header del calendario -->
  <div class="flex items-center justify-between mb-6 sm:mb-8 lg:mb-10">
    <h2
      class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white"
    >
      {format(currentDate, "MMMM yyyy", { locale: es })}
    </h2>
    <div class="flex items-center space-x-2">
      <button
        class="p-1.5 sm:p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
      >
        <svg
          class="w-4 h-4 sm:w-5 sm:h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <button
        class="p-1.5 sm:p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
      >
        <svg
          class="w-4 h-4 sm:w-5 sm:h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Vista de LISTA para móviles (oculta en desktop) -->
  <div class="md:hidden mobile-list-view">
    {
      daysInMonth.map((day, index) => {
        const dayEvents = getEventsForDay(day);
        if (dayEvents.length === 0) return null;

        const isCurrentDay = isToday(day);

        // Contar cuántos días con eventos hay antes de este
        const daysWithEventsBefore = daysInMonth
          .slice(0, index)
          .filter((d) => getEventsForDay(d).length > 0).length;

        // Mostrar solo los primeros 4 días con eventos inicialmente
        const isInitiallyHidden = daysWithEventsBefore >= 4;

        return (
          <div
            class={`mobile-day-item mb-4 p-4 rounded-lg border-2 transition-all duration-300 ${
              isInitiallyHidden ? "hidden" : ""
            } ${
              isCurrentDay
                ? "border-blue-500 bg-blue-50 dark:bg-blue-900/20"
                : "border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50"
            }`}
            data-initially-hidden={isInitiallyHidden}
          >
            <div class="flex items-center justify-between mb-3">
              <h3
                class={`text-lg font-bold ${
                  isCurrentDay
                    ? "text-blue-600 dark:text-blue-400"
                    : "text-gray-900 dark:text-white"
                }`}
              >
                {format(day, "EEEE d", { locale: es })}
              </h3>
              {isCurrentDay && (
                <span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-500 text-white">
                  Hoy
                </span>
              )}
            </div>
            <div class="space-y-2">
              {dayEvents.map((event) => (
                <button
                  class={`w-full text-left p-3 rounded-lg ${getEventColor(event.category)} text-white shadow-sm hover:shadow-md transition-all event-list-item`}
                  data-event-id={event.id}
                  data-day={format(day, "yyyy-MM-dd")}
                  data-events={JSON.stringify([
                    {
                      id: event.id,
                      title: event.title,
                      category: event.category,
                    },
                  ])}
                >
                  <div class="font-semibold text-sm mb-1">{event.title}</div>
                  <div class="text-xs opacity-90">
                    {format(parseISO(event.start), "HH:mm")} -{" "}
                    {format(parseISO(event.end), "HH:mm")}
                  </div>
                </button>
              ))}
            </div>
          </div>
        );
      })
    }

    <!-- Botón "Ver más" para mostrar todos los días -->
    <button
      id="mobile-show-more-btn"
      class="w-full py-4 px-6 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-2 group"
    >
      <span>Ver más días</span>
      <svg
        class="w-5 h-5 transform group-hover:translate-y-1 transition-transform"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"></path>
      </svg>
    </button>

    <!-- Botón "Ver menos" (inicialmente oculto) -->
    <button
      id="mobile-show-less-btn"
      class="hidden w-full py-4 px-6 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 items-center justify-center gap-2 group mt-4"
    >
      <span>Ver menos</span>
      <svg
        class="w-5 h-5 transform group-hover:-translate-y-1 transition-transform"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 15l7-7 7 7"></path>
      </svg>
    </button>
  </div>

  <!-- Vista de GRID para tablet/desktop (oculta en móvil) -->
  <div class="hidden md:block calendar-grid-view">
    <!-- Días de la semana -->
    <div class="grid grid-cols-7 gap-1 sm:gap-2 md:gap-3 lg:gap-5 mb-4 sm:mb-6">
      {
        ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"].map((day) => (
          <div class="text-center text-xs sm:text-sm md:text-base lg:text-lg font-bold text-gray-700 dark:text-gray-300 py-2 sm:py-3 lg:py-4">
            <span class="hidden sm:inline">{day}</span>
            <span class="sm:hidden">{day.charAt(0)}</span>
          </div>
        ))
      }
    </div>

    <!-- Días del calendario -->
    <div class="grid grid-cols-7 gap-1 sm:gap-2 md:gap-3 lg:gap-5">
      {
        calendarDays.map((day) => {
          if (!day) {
            return (
              <div class="min-h-[80px] sm:min-h-[120px] md:min-h-[200px] lg:min-h-[280px]" />
            );
          }

          const dayEvents = getEventsForDay(day);
          const isCurrentDay = isToday(day);

          return (
            <div class="calendar-day-wrapper relative">
              <div
                class={`
              calendar-day min-h-[80px] sm:min-h-[120px] md:min-h-[200px] lg:min-h-[280px] p-2 sm:p-3 md:p-4 lg:p-5 rounded-lg sm:rounded-xl border-2 transition-all duration-300 cursor-pointer
              ${
                isCurrentDay
                  ? "border-blue-500 bg-blue-50 dark:bg-blue-900/20 ring-2 ring-blue-300 dark:ring-blue-600"
                  : "border-gray-200 dark:border-gray-700 hover:border-gray-400 dark:hover:border-gray-500"
              }
              ${dayEvents.length > 0 ? "has-events hover:bg-gray-50 dark:hover:bg-gray-700/50" : ""}
            `}
                data-day={format(day, "yyyy-MM-dd")}
                data-has-events={dayEvents.length > 0}
                data-events={JSON.stringify(
                  dayEvents.map((e) => ({
                    id: e.id,
                    title: e.title,
                    category: e.category,
                  }))
                )}
              >
                <div class="h-full flex flex-col day-content">
                  <span
                    class={`
                text-sm sm:text-base md:text-lg lg:text-xl font-bold mb-1 sm:mb-2 md:mb-3 lg:mb-4 day-number
                ${isCurrentDay ? "text-blue-600 dark:text-blue-400" : "text-gray-700 dark:text-gray-300"}
              `}
                  >
                    {format(day, "d")}
                  </span>

                  {dayEvents.length > 0 && (
                    <div class="flex-1 flex flex-col gap-1 sm:gap-1.5 md:gap-2 overflow-y-auto events-container pr-0.5 sm:pr-1 scrollbar-thin scrollbar-thumb-gray-400 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent">
                      {dayEvents.map((event) => (
                        <div
                          class={`text-left px-1.5 sm:px-2 md:px-3 py-1 sm:py-1.5 md:py-2 rounded-md sm:rounded-lg text-[10px] sm:text-xs md:text-sm font-semibold text-white ${getEventColor(event.category)} hover:opacity-90 transition-opacity cursor-pointer shadow-sm event-item pointer-events-none`}
                          title={`${event.title}\n${format(parseISO(event.start), "HH:mm")} - ${format(parseISO(event.end), "HH:mm")}`}
                          data-event-id={event.id}
                        >
                          <div class="line-clamp-2 leading-tight">
                            {event.title}
                          </div>
                          <div class="text-[9px] sm:text-[10px] md:text-xs opacity-90 mt-0.5 sm:mt-1 hidden sm:block">
                            {format(parseISO(event.start), "HH:mm")}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        })
      }
    </div>
  </div>
  <!-- Fin de la vista GRID -->

  <!-- Leyenda actualizada con todas las categorías y colores oficiales -->
  <div
    class="mt-4 sm:mt-6 pt-4 sm:pt-6 border-t border-gray-200 dark:border-gray-700"
  >
    <h3
      class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 sm:mb-3"
    >
      Tipos de eventos
    </h3>
    <div
      class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 sm:gap-3"
    >
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-emerald-600 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >Community Day</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-red-600 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >Raid Day</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-purple-600 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >Evento</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-orange-500 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >Spotlight Hour</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-red-500 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >Raid Hour</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-sky-500 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >Max Monday</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-blue-700 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >PVP/GBL</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-teal-400 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >GO Pass</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-red-500 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >Raid Rotation</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-purple-600 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >Mega Rotation</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-gray-600 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >Shadow/Rocket</span
        >
      </div>
      <div class="flex items-center space-x-1.5 sm:space-x-2">
        <div
          class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-amber-500 flex-shrink-0"
        >
        </div>
        <span class="text-[10px] sm:text-xs text-gray-600 dark:text-gray-400"
          >Showcase</span
        >
      </div>
    </div>
  </div>
</div>

<script>
  function initCalendarClicks() {
    // Manejar clicks en la vista de GRID (tablet/desktop)
    const calendarDays = document.querySelectorAll(".calendar-day[data-day]");

    calendarDays.forEach((dayElement) => {
      // Clonar para eliminar listeners previos
      const newDay = dayElement.cloneNode(true) as HTMLElement;
      dayElement.parentNode?.replaceChild(newDay, dayElement);

      // Click en el día completo - siempre abre modal con todos los eventos
      newDay.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const dayDate = newDay.getAttribute("data-day");
        const eventsData = newDay.getAttribute("data-events");
        const hasEvents = newDay.getAttribute("data-has-events") === "true";

        if (eventsData && dayDate && hasEvents) {
          try {
            const events = JSON.parse(eventsData);
            if (events.length > 0) {
              // Siempre mostrar modal con TODOS los eventos del día
              window.dispatchEvent(
                new CustomEvent("calendar-day-selected", {
                  detail: {
                    date: dayDate,
                    events: events,
                  },
                })
              );
            }
          } catch (err) {
            console.error("Error parsing events data:", err);
          }
        }
      });
    });

    // Manejar clicks en la vista de LISTA (móvil)
    const eventListItems = document.querySelectorAll(".event-list-item");

    eventListItems.forEach((eventItem) => {
      eventItem.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const dayDate = eventItem.getAttribute("data-day");
        const eventsData = eventItem.getAttribute("data-events");

        if (eventsData && dayDate) {
          try {
            const events = JSON.parse(eventsData);
            if (events.length > 0) {
              window.dispatchEvent(
                new CustomEvent("calendar-day-selected", {
                  detail: {
                    date: dayDate,
                    events: events,
                  },
                })
              );
            }
          } catch (err) {
            console.error("Error parsing events data:", err);
          }
        }
      });
    });

    // Manejar botones "Ver más" y "Ver menos" en móvil
    const showMoreBtn = document.getElementById("mobile-show-more-btn");
    const showLessBtn = document.getElementById("mobile-show-less-btn");
    const hiddenDays = document.querySelectorAll(
      '.mobile-day-item[data-initially-hidden="true"]'
    );

    // Solo mostrar el botón "Ver más" si hay días ocultos
    if (showMoreBtn && hiddenDays.length > 0) {
      showMoreBtn.style.display = "flex";

      showMoreBtn.addEventListener("click", () => {
        hiddenDays.forEach((day) => {
          day.classList.remove("hidden");
          day.classList.add("animate-fade-in");
        });
        showMoreBtn.style.display = "none";
        if (showLessBtn) {
          showLessBtn.style.display = "flex";
        }

        // Scroll suave hacia el primer día revelado
        setTimeout(() => {
          if (hiddenDays[0]) {
            hiddenDays[0].scrollIntoView({
              behavior: "smooth",
              block: "nearest",
            });
          }
        }, 100);
      });
    } else if (showMoreBtn) {
      // Si no hay días ocultos, ocultar el botón "Ver más"
      showMoreBtn.style.display = "none";
    }

    if (showLessBtn) {
      showLessBtn.addEventListener("click", () => {
        hiddenDays.forEach((day) => {
          day.classList.add("hidden");
          day.classList.remove("animate-fade-in");
        });
        showLessBtn.style.display = "none";
        if (showMoreBtn) {
          showMoreBtn.style.display = "flex";
        }

        // Scroll suave hacia arriba del calendario
        const mobileListView = document.querySelector(".mobile-list-view");
        if (mobileListView) {
          mobileListView.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      });
    }
  }

  // Ejecutar inmediatamente
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initCalendarClicks);
  } else {
    initCalendarClicks();
  }

  // Ejecutar en transiciones de Astro
  document.addEventListener("astro:page-load", initCalendarClicks);
</script>
<style>
  /* Estado normal del día del calendario */
  .calendar-day-wrapper {
    position: relative;
  }

  .calendar-day {
    position: relative;
    z-index: 1;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Efecto hover: sutil */
  .calendar-day.has-events:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  /* Transición suave para todos los elementos */
  .event-item {
    transition: all 0.2s ease;
  }

  /* Contenedor de eventos con scroll visible */
  .events-container {
    max-height: 210px;
  }

  /* Estilos para scrollbar visible y atractivo */
  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
  }

  .scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background-color: rgba(156, 163, 175, 0.7);
  }

  .dark .scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: rgba(75, 85, 99, 0.5);
  }

  .dark .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background-color: rgba(75, 85, 99, 0.7);
  }

  /* Asegurar que el grid permita el posicionamiento absoluto */
  .grid {
    position: relative;
  }

  @keyframes pulse-slow {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }

  .animate-pulse-slow {
    animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
</style>
