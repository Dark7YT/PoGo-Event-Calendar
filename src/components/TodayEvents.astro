---
import { format } from "date-fns";
import { es } from "date-fns/locale";
import { getAllEvents } from "../data/events";
import type { Event } from "../data/events";

// Obtener la fecha actual
const today = new Date();
const todayStr = format(today, "yyyy-MM-dd");

// Obtener todos los eventos
const allEvents = getAllEvents();

// Filtrar eventos que est√°n activos hoy
const todayEvents = allEvents.filter((event) => {
  const eventStart = new Date(event.start);
  const eventEnd = new Date(event.end);
  const todayDate = new Date(todayStr);
  
  // Normalizar las fechas a medianoche para comparaci√≥n
  eventStart.setHours(0, 0, 0, 0);
  eventEnd.setHours(23, 59, 59, 999);
  todayDate.setHours(0, 0, 0, 0);
  
  return todayDate >= eventStart && todayDate <= eventEnd;
});

// Funci√≥n para obtener el color de la categor√≠a (coincide con EventCard)
function getEventCategoryColor(category: string): string {
  const colors: Record<string, string> = {
    COMMUNITY_DAY: "bg-green-500",
    EVENT: "bg-blue-500",
    RAID_DAY: "bg-red-500",
    RAID_HOUR: "bg-purple-500",
    SPOTLIGHT: "bg-yellow-500",
    MAX_MONDAY: "bg-pink-500",
    SHADOW_ROTATION: "bg-gray-600 dark:bg-gray-600",
    GO_PASS: "bg-teal-500",
    PVP: "bg-indigo-500",
    RAID_ROTATION: "bg-orange-500",
    MEGA_ROTATION: "bg-cyan-500",
    RESEARCH: "bg-yellow-500",
    OTHER: "bg-gray-500",
  };
  return colors[category] || colors.OTHER;
}

// Funci√≥n para obtener el color del borde (coincide con EventCard)
function getEventBorderColor(category: string): string {
  const colors: Record<string, string> = {
    COMMUNITY_DAY: "border-green-500",
    EVENT: "border-blue-500",
    RAID_DAY: "border-red-500",
    RAID_HOUR: "border-purple-500",
    SPOTLIGHT: "border-yellow-500",
    MAX_MONDAY: "border-pink-500",
    SHADOW_ROTATION: "border-slate-600",
    GO_PASS: "border-teal-500",
    PVP: "border-indigo-500",
    RAID_ROTATION: "border-orange-500",
    MEGA_ROTATION: "border-cyan-500",
    RESEARCH: "border-yellow-500",
    OTHER: "border-gray-500",
  };
  return colors[category] || colors.OTHER;
}

// Funci√≥n para obtener el nombre de la categor√≠a (coincide con EventCard)
function getCategoryName(category: string): string {
  const names: Record<string, string> = {
    COMMUNITY_DAY: "Community Day",
    EVENT: "Evento",
    RAID_DAY: "Raid Day",
    RAID_HOUR: "Raid Hour",
    SPOTLIGHT: "Spotlight Hour",
    MAX_MONDAY: "Max Monday",
    SHADOW_ROTATION: "Shadow Rotation",
    GO_PASS: "GO Pass",
    PVP: "GO Battle League",
    RAID_ROTATION: "Raid Rotation",
    MEGA_ROTATION: "Mega Rotation",
    RESEARCH: "Investigaci√≥n",
    OTHER: "Otro",
  };
  return names[category] || "Evento";
}
---

<section class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-700">
    <!-- Header con la fecha de hoy -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-8 text-center">
      <div class="flex items-center justify-center gap-3 mb-2">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        <h2 class="text-3xl sm:text-4xl font-bold text-white">
          Hoy
        </h2>
      </div>
      <p class="text-xl sm:text-2xl text-white/90 font-semibold">
        {format(today, "EEEE, d 'de' MMMM 'de' yyyy", { locale: es })}
      </p>
    </div>

    <!-- Contenido de eventos -->
    <div class="p-6">
      {todayEvents.length === 0 ? (
        <div class="text-center py-12">
          <svg class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
          </svg>
          <p class="text-lg text-gray-600 dark:text-gray-400 mb-2">
            No hay eventos programados para hoy
          </p>
          <p class="text-sm text-gray-500 dark:text-gray-500">
            Revisa el calendario para ver eventos pr√≥ximos
          </p>
        </div>
      ) : (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {todayEvents.map((event) => (
            <button
              class={`today-event-card text-left w-full p-4 rounded-xl border-2 ${getEventBorderColor(event.category)} bg-white dark:bg-gray-800 hover:shadow-xl transition-all duration-200 hover:scale-[1.01]`}
              data-event-id={event.id}
            >
              <!-- Header con color de categor√≠a -->
              <div class={`${getEventCategoryColor(event.category)} px-3 py-1.5 -mx-4 -mt-4 mb-3 rounded-t-lg`}>
                <div class="flex items-center justify-between">
                  <span class="text-white font-semibold text-xs uppercase tracking-wide">
                    {getCategoryName(event.category)}
                  </span>
                  <svg class="w-4 h-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </div>
              </div>

              <!-- T√≠tulo -->
              <h3 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white mb-2">
                {event.title}
              </h3>

              <!-- Horario -->
              <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 mb-3">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="font-medium">
                  {format(new Date(event.start), "HH:mm", { locale: es })} - {format(new Date(event.end), "HH:mm", { locale: es })}
                </span>
              </div>

              <!-- Preview de contenido -->
              {event.description && (
                <p class="text-sm text-gray-700 dark:text-gray-300 line-clamp-2 mb-3">
                  {event.description}
                </p>
              )}

              <!-- Highlights -->
              <div class="flex flex-wrap gap-2">
                {event.spawns && event.spawns.length > 0 && (
                  <span class="inline-flex items-center px-2 py-1 rounded-md text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">
                    üéØ {event.spawns.length} Pok√©mon
                  </span>
                )}
                {event.raids && event.raids.length > 0 && (
                  <span class="inline-flex items-center px-2 py-1 rounded-md text-xs bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300">
                    ‚öîÔ∏è {event.raids.length} Raids
                  </span>
                )}
                {event.bonuses && event.bonuses.length > 0 && (
                  <span class="inline-flex items-center px-2 py-1 rounded-md text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                    ‚ú® {event.bonuses.length} Bonos
                  </span>
                )}
              </div>
            </button>
          ))}
        </div>
      )}
    </div>
  </div>
</section>

<script>
  // Importar eventos desde el m√≥dulo
  import { getAllEvents } from "../data/events";
  import type { Event } from "../data/events";
  import { format, parseISO } from "date-fns";
  import { es } from "date-fns/locale";

  // Obtener todos los eventos
  const allEvents = getAllEvents();

  // Funci√≥n para abrir el modal con detalles del evento
  function openEventModal(eventId: string) {
    const event = allEvents.find((e) => e.id === eventId);
    if (!event) return;

    const modal = document.getElementById("event-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalContent = document.getElementById("modal-content");
    const modalHeader = document.getElementById("modal-header");

    if (!modal || !modalTitle || !modalContent || !modalHeader) return;

    // Funci√≥n para obtener clases de borde seg√∫n categor√≠a
    function getBorderClasses(category: string): string {
      const borderMap: Record<string, string> = {
        COMMUNITY_DAY: "border-l-8 border-green-500",
        EVENT: "border-l-8 border-blue-500",
        RAID_DAY: "border-l-8 border-red-500",
        RAID_HOUR: "border-l-8 border-purple-500",
        SPOTLIGHT: "border-l-8 border-yellow-500",
        MAX_MONDAY: "border-l-8 border-pink-500",
        SHADOW_ROTATION: "border-l-8 border-slate-600",
        GO_PASS: "border-l-8 border-teal-500",
        PVP: "border-l-8 border-indigo-500",
        RAID_ROTATION: "border-l-8 border-orange-500",
        MEGA_ROTATION: "border-l-8 border-cyan-500",
        RESEARCH: "border-l-8 border-yellow-500",
        OTHER: "border-l-8 border-gray-500",
      };
      return borderMap[category] || borderMap.OTHER;
    }

    // Funci√≥n para obtener el color de fondo del header seg√∫n categor√≠a
    function getHeaderBgClasses(category: string): string {
      const bgMap: Record<string, string> = {
        COMMUNITY_DAY: "bg-green-500",
        EVENT: "bg-blue-500",
        RAID_DAY: "bg-red-500",
        RAID_HOUR: "bg-purple-500",
        SPOTLIGHT: "bg-yellow-500",
        MAX_MONDAY: "bg-pink-500",
        SHADOW_ROTATION: "bg-gray-600",
        GO_PASS: "bg-teal-500",
        PVP: "bg-indigo-500",
        RAID_ROTATION: "bg-orange-500",
        MEGA_ROTATION: "bg-cyan-500",
        RESEARCH: "bg-yellow-500",
        OTHER: "bg-gray-500",
      };
      return bgMap[category] || bgMap.OTHER;
    }

    // Funci√≥n para obtener colores de las secciones seg√∫n categor√≠a
    function getSectionColors(category: string) {
      const colorMap: Record<string, { icon: string, bg: string, text: string }> = {
        COMMUNITY_DAY: { icon: "text-green-600 dark:text-green-400", bg: "bg-green-50 dark:bg-green-900/20", text: "text-green-700 dark:text-green-300" },
        EVENT: { icon: "text-blue-600 dark:text-blue-400", bg: "bg-blue-50 dark:bg-blue-900/20", text: "text-blue-700 dark:text-blue-300" },
        RAID_DAY: { icon: "text-red-600 dark:text-red-400", bg: "bg-red-50 dark:bg-red-900/20", text: "text-red-700 dark:text-red-300" },
        RAID_HOUR: { icon: "text-purple-600 dark:text-purple-400", bg: "bg-purple-50 dark:bg-purple-900/20", text: "text-purple-700 dark:text-purple-300" },
        SPOTLIGHT: { icon: "text-yellow-600 dark:text-yellow-400", bg: "bg-yellow-50 dark:bg-yellow-900/20", text: "text-yellow-700 dark:text-yellow-300" },
        MAX_MONDAY: { icon: "text-pink-600 dark:text-pink-400", bg: "bg-pink-50 dark:bg-pink-900/20", text: "text-pink-700 dark:text-pink-300" },
        SHADOW_ROTATION: { icon: "text-gray-600 dark:text-gray-400", bg: "bg-gray-50 dark:bg-gray-900/20", text: "text-gray-700 dark:text-gray-300" },
        GO_PASS: { icon: "text-teal-600 dark:text-teal-400", bg: "bg-teal-50 dark:bg-teal-900/20", text: "text-teal-700 dark:text-teal-300" },
        PVP: { icon: "text-indigo-600 dark:text-indigo-400", bg: "bg-indigo-50 dark:bg-indigo-900/20", text: "text-indigo-700 dark:text-indigo-300" },
        RAID_ROTATION: { icon: "text-orange-600 dark:text-orange-400", bg: "bg-orange-50 dark:bg-orange-900/20", text: "text-orange-700 dark:text-orange-300" },
        MEGA_ROTATION: { icon: "text-cyan-600 dark:text-cyan-400", bg: "bg-cyan-50 dark:bg-cyan-900/20", text: "text-cyan-700 dark:text-cyan-300" },
        RESEARCH: { icon: "text-yellow-600 dark:text-yellow-400", bg: "bg-yellow-50 dark:bg-yellow-900/20", text: "text-yellow-700 dark:text-yellow-300" },
        OTHER: { icon: "text-gray-600 dark:text-gray-400", bg: "bg-gray-50 dark:bg-gray-900/20", text: "text-gray-700 dark:text-gray-300" },
      };
      return colorMap[category] || colorMap.OTHER;
    }

    const colors = getSectionColors(event.category);

    // Actualizar el t√≠tulo del modal
    modalTitle.textContent = event.title;

    // Aplicar las clases de borde y color de fondo al header del modal
    modalHeader.className =
      "sticky top-0 z-10 px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between shadow-lg " +
      getHeaderBgClasses(event.category) + " " +
      getBorderClasses(event.category);

    // Construir el contenido del modal
    let content = `
      <div class="space-y-4 sm:space-y-6">
        <!-- Fecha y hora -->
        <div class="${colors.bg} rounded-lg p-3 sm:p-4">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 sm:w-6 sm:h-6 ${colors.icon} flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <div class="flex-1 min-w-0">
              <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-1">Fecha y Hora</h3>
              <p class="text-sm sm:text-base text-gray-700 dark:text-gray-300">
                ${format(parseISO(event.start), "EEEE, d 'de' MMMM 'de' yyyy", { locale: es })}
              </p>
              <p class="text-sm sm:text-base text-gray-700 dark:text-gray-300">
                ${format(parseISO(event.start), "HH:mm", { locale: es })} - ${format(parseISO(event.end), "HH:mm", { locale: es })}
              </p>
            </div>
          </div>
        </div>
    `;

    // Descripci√≥n
    if (event.description) {
      content += `
        <div>
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-3">Descripci√≥n</h3>
          <p class="text-sm sm:text-base text-gray-700 dark:text-gray-300 leading-relaxed">${event.description}</p>
        </div>
      `;
    }

    // Pok√©mon que aparecer√°n
    if (event.spawns && event.spawns.length > 0) {
      content += `
        <div>
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-3">üéØ Pok√©mon que aparecer√°n</h3>
          <div class="flex flex-wrap gap-2">
            ${event.spawns.map((spawn) => `<span class="px-2 sm:px-3 py-1 sm:py-1.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg text-xs sm:text-sm font-medium">${spawn}</span>`).join("")}
          </div>
        </div>
      `;
    }

    // Incursiones
    if (event.raids && event.raids.length > 0) {
      content += `
        <div>
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-3">‚öîÔ∏è Incursiones</h3>
          <div class="flex flex-wrap gap-2">
            ${event.raids.map((raid) => `<span class="px-2 sm:px-3 py-1 sm:py-1.5 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-lg text-xs sm:text-sm font-medium">${raid}</span>`).join("")}
          </div>
        </div>
      `;
    }

    // Bonificaciones
    if (event.bonuses && event.bonuses.length > 0) {
      content += `
        <div>
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-3">‚ú® Bonificaciones</h3>
          <ul class="space-y-1 sm:space-y-2">
            ${event.bonuses.map((bonus) => `<li class="flex items-start gap-2 text-sm sm:text-base text-gray-700 dark:text-gray-300"><span class="text-blue-600 dark:text-blue-400 flex-shrink-0">‚Ä¢</span><span>${bonus}</span></li>`).join("")}
          </ul>
        </div>
      `;
    }

    // Debuts
    if (event.debuts && event.debuts.length > 0) {
      content += `
        <div>
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-3">üåü Debuts</h3>
          <div class="flex flex-wrap gap-2">
            ${event.debuts.map((debut) => `<span class="px-2 sm:px-3 py-1 sm:py-1.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-lg text-xs sm:text-sm font-medium">${debut}</span>`).join("")}
          </div>
        </div>
      `;
    }

    // Movimientos destacados
    if (event.featuredMoves && event.featuredMoves.length > 0) {
      content += `
        <div>
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-3">‚ö° Movimientos Destacados</h3>
          <div class="flex flex-wrap gap-2">
            ${event.featuredMoves.map((move) => `<span class="px-2 sm:px-3 py-1 sm:py-1.5 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg text-xs sm:text-sm font-medium">${move}</span>`).join("")}
          </div>
        </div>
      `;
    }

    // Tareas de investigaci√≥n
    if (event.researchTasks && event.researchTasks.length > 0) {
      content += `
        <div>
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-3">üìã Tareas de Investigaci√≥n</h3>
          <ul class="space-y-1 sm:space-y-2">
            ${event.researchTasks.map((task) => `<li class="flex items-start gap-2 text-sm sm:text-base text-gray-700 dark:text-gray-300"><span class="text-purple-600 dark:text-purple-400 flex-shrink-0">‚Ä¢</span><span>${task}</span></li>`).join("")}
          </ul>
        </div>
      `;
    }

    content += `</div>`;
    modalContent.innerHTML = content;

    // Mostrar el modal
    modal.classList.remove("hidden");
    modal.classList.add("show");
    document.body.classList.add("modal-open");
  }

  // Event listeners para los cards de eventos de hoy
  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    const card = target.closest(".today-event-card");
    
    if (card) {
      const eventId = (card as HTMLElement).dataset.eventId;
      if (eventId) {
        openEventModal(eventId);
      }
    }
  });
</script>

<style>
  .today-event-card {
    cursor: pointer;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
